# WMS 레이어 구조 설계서
**파일명:** 레이어구조.md  
**버전:** v0.1  
**대상:** WMS / GEUL 설계 및 구현자  

---

## 1. 개요

WMS는 “세계(World)”를 하나의 거대한 그래프로 관리하는 시스템이다.  
이때 **“무엇이 실제 세계의 상태인가?”**와 **“누가 뭐라고 말했는가?”**를 구분하기 위해,  
WMS는 다음과 같은 다층 레이어 구조를 가진다.

- **L0. 커널 레이어 (Kernel Layer)** — 수학·논리 엔진 (암묵적, 코드)
- **L1. 월드 상태 레이어 (World State Layer)** — “지금 이 세계는 이렇게 되어 있다”
- **L2. 규칙·추론 레이어 (Rule & Inference Layer)** — “어떤 룰로 상태를 판단할 것인가”
- **L3. 서술 레이어 (Narrative Layer)** — “누가 무엇을 어떻게 말했다 / 기록했다”

이 문서는 이 4개 레이어가 어떤 역할을 하고,  
서로 어떻게 상호작용하는지 정의한다.

---

## 2. 레이어 전체 그림

### 2.1 개념 다이어그램

```text
           ┌──────────────────────────────┐
           │  L0. Kernel Layer            │
           │  - 수학, 논리, 자료구조      │
           │  - SIMD, 인덱스, 쿼리 엔진   │
           └───────────────┬──────────────┘
                           │
           ┌───────────────▼──────────────┐
           │  L1. World State Layer       │
           │  - Entity / Edge 그래프      │
           │  - 시점별 세계 상태          │
           │  - Canon / Branch 관리       │
           └───────────────┬──────────────┘
                           │
           ┌───────────────▼──────────────┐
           │  L2. Rule & Inference Layer  │
           │  - 물리/규범/게임 룰         │
           │  - 모순 탐지 & 추론          │
           │  - 신뢰도 스코어링           │
           └───────────────┬──────────────┘
                           │
           ┌───────────────▼──────────────┐
           │  L3. Narrative Layer         │
           │  - 뉴스/로그/소설/발화       │
           │  - Event6 / Triple GEUL      │
           │  - 출처, POV, 한정사         │
           └──────────────────────────────┘
````

### 2.2 데이터 흐름 개요

1. **입력:**

   * 자연어, 로그, 소설, 대화 → GEUL 서술로 변환 → **L3 저장**
2. **정제:**

   * L2의 룰/추론 엔진이 L3 서술을 평가 → 모순/신뢰도/적합성 분석
3. **반영:**

   * L2 결과를 바탕으로 L1의 “세계 상태 그래프”를 갱신
4. **출력:**

   * 쿼리/시뮬레이션은 L1을 기준으로 수행
   * 필요하면 L3 원 서술까지 추적 제공 (“출처 설명”)

---

## 3. L0. 커널 레이어 (Kernel Layer)

> **역할:** WMS 전체의 “수학·논리 엔진”이자 실행 환경.
> **형태:** 코드(Go, C 등)로 구현되며, 데이터로 저장되지 않는 층.

### 3.1 포함 내용

* 수학/논리 연산:

  * 정수/실수 연산, 비교, 조건 분기
  * 그래프 탐색, N-hop, 경로 검색
* 자료구조:

  * 인덱스 구조 (해시, B-Tree, CSR 등)
  * SIMD 비트마스크 필터
* 보증:

  * `1 + 1 = 2` 같은 수학적 진실
  * 구조적 불변식 (예: Edge는 항상 유효한 SIDX를 가리켜야 한다)

### 3.2 특징

* **월드 파일의 일부가 아니다.**
* 모든 World는 이 L0 위에서만 돌아간다.
* 수학/논리는 “월드와 무관한 절대 진실”로 취급한다.

---

## 4. L3. 서술 레이어 (Narrative Layer)

> **역할:**
> 세상에서 나온 모든 **“말/기록/보도/대사/로그”**를
> 가공 없이 GEUL로 저장하는 **원시 서술 저장소**.

### 4.1 저장 대상

* 뉴스 기사: “2024년 10월, A가 B를 공격했다”
* 소설 문장: “이순신은 바다를 사랑했다”
* 회의록: “대표가 매출 목표를 상향 조정하라고 지시했다”
* 대화: “김 대리가 그러던데…”

### 4.2 데이터 구조 (GEUL 기준)

* **Event6 Edge**

  * Who / What / Whom / When / Where / Why
  * “사건/행위”의 6하원칙 표현
* **Triple Edge**

  * (Subject, Property, Object)
  * “A는 B다”, “A는 C의 친구다” 같은 정적 관계
* **Verb Node**

  * 동사 + 동사 한정사(시제, 상, 증거성, 확신, 반복성…)

각 서술에는 반드시 **Context**가 붙는다:

* World (어느 세계에서 한 말인가)
* Time (언제 기록/발화 되었나)
* POV (누가 말했나, 어떤 관점인가)
* Modality (소설, 기사, 루머, 회상, 꿈…)

### 4.3 특징

* **모순 허용:**

  * “A가 살아 있다” / “A가 죽었다” 같은 상충 정보도 공존 가능
* **append-only 로그에 가까움:**

  * 원 서술은 되도록 삭제/수정하지 않는다.
* **진실 여부는 판단하지 않는다:**

  * L3는 “누가 뭐라고 했는가”만 책임진다.
    이게 실제로 맞는지는 L2/L1의 역할.

---

## 5. L2. 규칙·추론 레이어 (Rule & Inference Layer)

> **역할:**
> L3 서술들을 “이 World에서 통용되는 룰”에 비추어 평가·정제하고,
> 결과를 L1 월드 상태로 반영하는 **중간 심판·추론 레이어**.

L2는 크게 두 부분으로 나뉜다:

* **Rule Graph (규칙 그래프)**
* **Inference Engine (추론 엔진)**

### 5.1 Rule Graph (규칙 그래프)

**“이 세계에서 무엇이 가능한가 / 허용되는가 / 강제되는가”를 명시하는 그래프.**

#### 5.1.1 예시

* 물리 룰:

  * “이 World에서는 중력 = 9.8 m/s²”
  * “질량 보존 법칙은 항상 성립”
* 규범/계약 룰:

  * “계약 A를 위반하면 상태 X로 플래그”
  * “이 ERP World에서 `잔고 < 0`은 에러 상태”
* 서사 룰 (소설 World):

  * “작가의 최종 원고가 Canon이다”
  * “동일 인물의 생몰 연대는 자기모순이 나면 오류로 플래그”

#### 5.1.2 구현 방식

* `RuleNode`, `RuleEdge` 타입 (GEUL Standard 내 정의)
* 패턴:

  * 조건(Condition) → 결과(Consequence)
  * 금지(Forbidden), 허용(Allowed), 의무(Required)
  * 제약(Constraint), 보존량(Conservation)

---

### 5.2 Inference Engine (추론 엔진)

**L3 서술 + Rule Graph → L1 월드 상태로 정제/반영.**

#### 5.2.1 하는 일

1. **Consistency Check (정합성 검사)**

   * L3에 새 Event/Triple이 들어오면:

     * Rule 위반 여부 검사
     * 기존 L1 상태와 충돌 여부 검사
     * 같은 대상에 대한 다른 서술들과 비교

2. **Scoring (신뢰도 평가)**

   * 출처(Source), 증거성(Evidentiality), 시간, POV 등을 기반으로
     **“이 서술이 얼마나 그럴듯한가”**를 스코어링.
   * 예: 공신력 높은 기관 vs 익명 제보

3. **World Update (상태 반영)**

   * 충돌하는 후보 상태들 중에서:

     * Canon(정전) 그래프
     * Alternate(대안 세계선)
     * Hypothesis(가설 그래프)
   * 로 분기 관리 가능.

4. **Explain (설명용 추적)**

   * “왜 이 값을 이렇게 믿고 있는가?”에 대해

     * 어떤 L3 서술들이 기여했는지,
     * 어떤 Rule에 의해 다른 서술이 밀려났는지
   * 추출 가능.

#### 5.2.2 구현 포인트

* 규칙 기반 + 통계/ML 혼합 구조까지 확장 가능:

  * 규칙 위반, 하드 제약 → 심볼릭 로직
  * 불확실성, 모호성 → 신경망 스코어
* 초기 버전에서는 **심플한 규칙 엔진**부터 시작:

  * “동일 엔티티 + 동일 속성 + 상충값 → 가장 최근 + 신뢰도 높은 것 선택”
  * “월드 룰을 위반하면 에러 플래그”

---

## 6. L1. 월드 상태 레이어 (World State Layer)

> **역할:**
> 각 World/Context에 대해 **“지금 이 세계는 이런 상태다”**라고 선언된,
> 정제된 그래프를 유지하는 레이어.

### 6.1 데이터 모델

* **Entity Node**

  * 인물, 장소, 조직, 사물, 추상 개념 등
  * SIDX(64bit) + TID(스트림 내 단축 ID)
* **Property / Relation Edge (Triple 기반)**

  * “A는 B이다”, “A는 C의 친구다”
* **Event6 Edge**

  * 사건/행위를 시간축 위에 배치
* **Context Node**

  * World, Time, POV, Modality를 묶는 컨텍스트

### 6.2 특징

* 쿼리의 기본 대상은 항상 L1:

  * “2020년에 미국 대통령은 누구?”
  * “이 캐릭터의 현재 관계망 보여줘”
  * “이 시점 이후 발생한 전투 리스트”
* 하나의 World에 대해 여러 버전/트랙을 가질 수 있음:

  * RealWorld Canon
  * 특정 소설의 Canon
  * What-if 시뮬레이션 World
* world.gwms 파일 포맷, SoA 버킷, SIMD 최적화 등은
  **모두 L1의 물리 구현에 해당**한다.

---

## 7. 레이어 간 흐름 예시

### 7.1 예시 1: 뉴스 ingest → 현실 World 업데이트

1. **L3 (서술)**

   * 여러 언론사의 기사 문장을 GEUL Event/Triple로 저장
   * 각 서술에는 출처, 시간, 기자, 매체 등 Context 부여

2. **L2 (규칙·추론)**

   * Rule:

     * “서로 다른 날짜가 보도되면, 추가 근거가 나타날 때까지 보류”
     * “국가기관 발표 > 주요 언론 > 개인 블로그 순으로 신뢰도 가중치”
   * 여러 L3 서술을 비교하여 **가장 그럴듯한 날짜/사건 구조** 선택

3. **L1 (월드 상태)**

   * RealWorld Canon 그래프에 “2024-05-10 사건 X 발생”으로 반영
   * 나중에 쿼리:

     * “사건 X는 언제 발생했어?” → L1에서 바로 응답
     * “왜 그렇게 보지?” → L3 서술 + L2 추론 경로까지 추적 가능

---

### 7.2 예시 2: 소설 World 집필 지원

1. **L3 (서술)**

   * 작가의 문장을 문단 단위로 GEUL 서술로 저장:

     * Event6: “3장에서 A가 B를 배신했다”
     * 대사: “A가 ‘나는 원래부터 널 싫어했어’라고 말했다”
2. **L2 (규칙·추론)**

   * Rule:

     * “이 World에서 작가 텍스트는 Canon 후보”
     * “동일 인물의 생몰 연대/관계가 자기모순이면 경고”
   * 이전 장들과의 모순 여부 확인
3. **L1 (월드 상태)**

   * “배신 이전에는 A↔B = 친구”, “이후에는 A↔B = 적대”로 관계 그래프 업데이트
   * 7장 집필 시:

     * “지금 시점에서 A와 B는 어떤 사이냐?” → L1에서 즉시 답변
     * 작가가 설정 꼬이게 쓰려고 하면 경고 가능

---

## 8. 구현 우선순위 제안

당장 모든 레이어를 완벽히 구현할 필요는 없다.
초기 글월 v0.1 / 개인 월드빌딩 용도 기준으로는:

1. **L1 기본 구현**

   * Entity/Triple/Event6 저장
   * 간단한 시점 필터, 관계 조회
2. **L3 최소 구현**

   * “내가 직접 입력한 설정/사건들”을 Event/Triple로 보관
   * 출처/POV는 “author” 정도만
3. **L2는 규칙 몇 개만 하드코딩**

   * 나이/연대 자기모순 체크
   * 같은 엔티티의 단일-valued 속성(예: 생년)은 마지막 입력 우선

이후 확장 단계에서:

* L2 Rule Graph를 GEUL로 정식 정의
* L3에 뉴스/외부 텍스트 인입
* 신뢰도/출처 기반 추론 강화

---

## 9. 요약

* **L3 (서술)**:
  “누가 뭐라고 했는가”를 GEUL로 모조리 쌓는 층. 모순 허용, 판단 없음.

* **L2 (규칙·추론)**:
  “이 World에서 무엇을 믿을 것인가”를
  물리/규범/게임 룰과 출처·증거성을 바탕으로 결정하는 심판 층.

* **L1 (월드 상태)**:
  “지금 이 세계는 이렇게 되어 있다”라는
  쿼리 가능한 그래프를 유지하는 핵심 저장소 층.

* **L0 (커널)**:
  수학·논리·자료구조를 담당하는 실행 엔진.
  월드와 무관한 절대적인 연산 규칙.

이 구조를 기준으로, 이후

* world.gwms 파일 포맷,
* GEUL 스트림 설계,
* 글월 UI,
  모두 이 레이어 구분을 명시적으로 의식하면서 설계하면 된다.
