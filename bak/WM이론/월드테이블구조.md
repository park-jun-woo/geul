# 월드 테이블 구조 설계서 (`WorldTable구조.md`)

GEUL WORLD ENGINE / WMS v0.x  
작성자: (설계 초안)  
목적: World 단위로 **FACT / RULE / BOOK** 테이블을 어떻게 나누고,  
각 테이블이 **타임라인(Timeline)** 및 **메타데이터**와 어떻게 연결되는지 정의.

---

## 1. 개요

### 1.1 World = 컨테이너

`World`는 하나의 **세계관 / 조직 / 시스템**을 나타내는 최상위 단위다.

- 예시
  - `World: RealWorld_KR_2025`
  - `World: MyNovel_Arthur`
  - `World: AcmeCorp_ERP`

각 World는 내부에 여러 개의 **Table**을 가진다:

- `FACT` : **월드 상태 (State)** 를 담는 테이블들
- `RULE`  : **법칙 / 규칙 (Rules)** 을 담는 테이블들
- `BOOK`  : **서술 (Narrative / Log / Report)** 을 담는 테이블들

> 핵심 아이디어  
> - **FACT/RULE** 은 인간 인식 구조에 맞춰 **타임라인 기반** 설계를 채택  
> - **BOOK** 은 타임라인을 직접 안 갖고,  
>   단지 “언제 기록됐는지 / 언제 일어난 일인지” 를 **메타 엣지**로만 표현

---

## 2. World 오브젝트 구조

### 2.1 World 메타 구조 (개념)

```text
World {
  world_id: uint64
  name: string
  description: string
  created_at: timestamp
  updated_at: timestamp

  // 테이블 레지스트리
  tables: [TableRef...]

  // 타임라인 설정
  timeline: {
    time_zone: string         // "Asia/Seoul", "UTC" 등
    calendar: string          // "Gregorian", "GameCalendar_X" 등
    keyframe_model_table_id: TableId // 타임라인 Keyframe 엔티티가 들어있는 FACT 테이블
  }
}
````

### 2.2 TableRef 메타 구조

```text
TableRef {
  table_id: uint64
  world_id: uint64
  kind: enum { FACT, RULE, BOOK }
  name: string           // "core_model", "law_kr", "customer_calls" 등
  canonical: bool        // 주 참조 대상인지 (예: 메인 모델, 메인 룰셋)
  tags: [string]         // "realworld", "fiction", "finance", ...
  schema_hint: string    // 선택: 사람에게 보여줄 스키마 설명
}
```

* **한 World 안에 FACT / RULE / BOOK 테이블을 여러 개 둘 수 있음**

  * FACT: `core_model`, `character_model`, `erp_model` …
  * RULE: `law_kr_2025`, `game_rule_v2`, `hr_policy_2024` …
  * BOOK: `novel_volume1`, `customer_calls_2025`, `incident_reports` …

---

## 3. 타임라인 & Keyframe 개념

### 3.1 Timeline Keyframe = 시간 축의 앵커

* 인간 인식은 **“언제 일어났는가?”** 를 기준으로 정리됨
* GWMS도 World마다 **타임라인 엔티티**를 명시적으로 둔다

```text
TimeKeyframe (FACT 엔티티의 한 종류)
- id: SIDX
- label: "2025-01-01T00:00:00+09:00", "임진왜란 발발", "Chapter 3 시작" 등
- absolute_time: timestamp?   // 현실 세계 기준 절대 시간 (있을 수도, 없을 수도)
- world_time_code: string?    // 소설/게임 전용 시간 표현 (예: "Y3-M2-D10")
- granularity: enum { INSTANT, DAY, MONTH, ERA, CHAPTER }
- metadata: {...}
```

* **World.timeline.keyframe_model_table_id** 에 이 엔티티들이 들어감
* FACT / RULE / BOOK 어디서든 이 Keyframe을 참조할 수 있음

---

## 4. FACT 테이블 구조

### 4.1 역할

* **“이 세계가 특정 시점에 어떻게 되어 있는가?”** 를 표현하는 테이블
* 예:

  * 인물/장소/조직 상태
  * 소설/게임의 캐릭터 상태
  * 기업의 계좌/재고/조직도 상태
* L1 월드 레이어의 “정제된 canonical state” 저장소

### 4.2 데이터 단위

FACT 테이블은 결국 **노드(Node)와 엣지(Edge)**의 집합이다.

```text
ModelTable {
  table_id: uint64
  kind: FACT

  nodes: [ModelNode...]
  edges: [ModelEdge...]
}
```

```text
ModelNode {
  mid: SIDX           // GEUL 엔티티 ID
  type: NodeType     // PERSON, ORG, ITEM, TIME_KEYFRAME, ...
  properties: {...}  // 이름, 속성 등
  // 타임라인 앵커 (선택)
  valid_from: KeyframeRef?  // 언제부터
  valid_until: KeyframeRef? // 언제까지 (없으면 "현재/미래까지")
}

ModelEdge {
  id: EdgeId
  ctx: SIDX             // Context (world, pov, modality)
  subj: SIDX
  prop: PropId         // 관계/속성 타입
  obj: SIDX

  valid_from: KeyframeRef?
  valid_until: KeyframeRef?
}
```

* **Timeline Keyframe은 FACT 테이블 안의 특수 노드 타입**

  * 다른 모든 모델 엔티티/엣지들이
    `valid_from / valid_until`에서 이들을 참조함

---

## 5. RULE 테이블 구조

### 5.1 역할

* **법칙/규칙/정책/계약**을 표현
* 예:

  * 법률, 사내 규정, 게임 룰, 물리 법칙, 마법 규칙
* L2 Rule 레이어의 데이터 저장소

### 5.2 데이터 단위

```text
RuleTable {
  table_id: uint64
  kind: RULE

  rules: [RuleNode...]
  edges: [RuleEdge...]   // 트리거/적용대상/효과 정의
}
```

```text
RuleNode {
  rid: RID              // Rule ID (SIDX 또는 별도 ID)
  category: RuleCategory // "CRIMINAL_LAW", "GAME_MECHANIC", ...
  text: string?          // 사람 읽기용 설명
  compiled: Bytecode?    // 컴파일된 실행 형식 (옵션)

  // 타임라인 (법/규정 개정 지원)
  effective_from: KeyframeRef?  // 이 룰이 효력을 갖기 시작한 시점
  effective_until: KeyframeRef? // 폐기/개정 시점
}
```

```text
RuleEdge {
  id: EdgeId

  // 어떤 패턴에 반응하는가 (Trigger)
  trigger_pattern: PatternRef?   // Triple/Event6 패턴 (GEUL 기반)
  trigger_link: SIDX?             // "동사ID" 등으로의 링크

  // 적용 범위
  scope_world: WorldRef?         // 특정 월드 또는 서브월드
  scope_ctx: SIDX?                // Context (POV, Modal 등)
  scope_filter: {...}            // Entity 타입, 태그 등

  // 효과 (Effect)
  effect_ref: SIDX?               // "벌점 부과 규칙", "HP -10" 같은 액션 노드
  effect_compiled: Bytecode?     // 바로 실행 가능한 포맷 (옵션)

  // 타임라인
  effective_from: KeyframeRef?
  effective_until: KeyframeRef?
}
```

* **포인트**

  * RULE도 **Timeline Keyframe**을 사용해서
    “언제부터 언제까지 유효한 룰인가?” 를 표현
  * 법 개정, 패치 업데이트, 시즌별 규칙 변경 모두 자연스럽게 표현 가능

---

## 6. BOOK 테이블 구조

### 6.1 역할

* **서술(Narrative) / 로그(Log) / 보고서(Report)** 저장
* 예:

  * 소설의 문단, 대사, 장면 설명
  * 고객센터 통화 내용
  * 장애 보고서, 일일 업무 보고
* **L3 서술 레이어**의 원본 데이터

### 6.2 중요한 원칙

> **BOOK 테이블 자체에는 “타임라인 축”이 없다.**

* 타임라인 인덱스를 강제하지 않는다
* 대신, 필요할 때 **Meta Edge로 “언제 기록됐는지 / 어떤 시간을 가리키는지”**를 담는다
* 즉:

  * **기록 시간(Record Time)** 과
  * **사건 시간(Event Time)** 을 **분리**하여 메타데이터로 표현

### 6.3 데이터 단위

```text
BookTable {
  table_id: uint64
  kind: BOOK

  entries: [BookEntry...]
  edges: [BookEdge...]    // 서술 내부 구조화용 (선택)
}
```

```text
BookEntry {
  bid: BID               // Book Entry ID
  source_ref: string?    // 파일 경로, 콜 녹취 ID, 문서 ID 등
  text: string           // 원문 (문단/대사/문서 요약 등)

  // 메타 시간: "이 기록이 언제 만들어졌는가?"
  recorded_at: timestamp // 시스템/로그상의 기록 시각 (항상 존재)

  // 메타 시간 2: "무슨 시점을 가리키는 내용인가?"
  // - 없을 수도 있음 (미추론 / 시간 언급 없음)
  event_time_explicit: timestamp?   // 명시적으로 나온 경우 (예: "2025-01-03 10:00")
  event_time_keyframe: KeyframeRef? // World 타임라인과 앵커링한 경우
  event_time_confidence: float?     // 추론 시 신뢰도 (0.0~1.0)

  // 월드와의 연결 (선택)
  related_entities: [SIDX...]        // 이 서술이 언급하는 엔티티들
  related_events: [SIDX...]          // 이미 Model에 있는 Event 노드들
}
```

* **BookEdge** (선택적 구조화)

  * 한 BookEntry 내부의 구조(문장 단위, 발화자, 대화 turn)를
    더 잘게 나누고 싶을 때만 사용

---

## 7. 서술 시간 표현: Meta Edge로 처리

### 7.1 Meta Edge 개념

BOOK 자체는 Timeline을 갖지 않지만,
개별 서술 또는 서술 내부 요소를 **타임라인에 연결하는 "메타 엣지"**는 정의한다.

예시 (GEUL 스타일 의미):

```text
[BookEntry#123] --(book:RECORDED_AT)--> [TimeNode("2025-01-10T15:00:00")]
[BookEntry#123] --(book:EVENT_AT)-----> [TimeKeyframe#K2025_Week1]
[BookEntry#123] --(book:ABOUT_ENTITY)-> [Customer#C001]
[BookEntry#123] --(book:ABOUT_EVENT)--> [Incident#INC_999]
```

* `RECORDED_AT`

  * 이 서술이 **언제 기록/발화/저장되었는지**
  * 거의 항상 존재 (로그 타임스탬프)
* `EVENT_AT`

  * 이 서술이 **어떤 시점의 사건을 지칭하는지**
  * 있을 수도 있고, 없을 수도 있음
  * NLP/GEUL 파서가 “어제”, “지난주 금요일”을 해석해서
    타임라인 Keyframe에 앵커링하면 채워 넣음

---

## 8. 전체 그림: FACT / RULE / BOOK 상호 관계

### 8.1 레이어 관점 정리

* **FACT (L1)**

  * “지금/그때 그 세계는 어떤 상태였나?”
  * 타임라인 Keyframe과 강하게 결합
* **RULE (L2)**

  * “이 세계에서 어떤 법칙이, 어느 시점부터 언제까지 적용되는가?”
  * 타임라인 Keyframe 기반의 유효기간(effective_from / until)을 가짐
* **BOOK (L3)**

  * “누가, 언제, 무엇이라고 말하거나 썼는가?”
  * 독립적인 타임라인 축은 없음
  * 다만 `RECORDED_AT`, `EVENT_AT` 메타 엣지로
    **Model/Rule의 타임라인에 느슨하게 앵커링** 가능

### 8.2 예시 시나리오

#### 상황

* World: `AcmeCorp_2025`
* FACT 테이블: `core_model`
* RULE 테이블: `hr_policy_2025`
* BOOK 테이블: `customer_calls_2025`

#### 1) Model: 장애 이벤트 기록

```text
[Incident#100]
  type: INCIDENT
  description: "2025-01-03 결제 이중 청구"
  valid_from: [Keyframe#2025-01-03T10:05]
  valid_until: null
```

#### 2) Rule: 환불 정책 개정

```text
[Rule#REFUND_V1]
  effective_from: [Keyframe#2024-01-01]
  effective_until: [Keyframe#2025-01-15]

[Rule#REFUND_V2]
  effective_from: [Keyframe#2025-01-15]
  effective_until: null
```

#### 3) Book: 고객센터 통화 기록

```text
BookEntry#C1234
  text: "지난주 금요일에 결제가 두 번 빠졌어요."
  recorded_at: 2025-01-10T15:00:00

  event_time_explicit: null
  event_time_keyframe: [Keyframe#2025-01-03]   // 파서/SCULPT가 추론 후 연결
  event_time_confidence: 0.92

  related_events: [Incident#100]
  related_entities: [Customer#C001, Service#PAYMENT]
```

* 이 구조 덕분에, 나중에 쿼리할 수 있다:

  * "Rule#REFUND_V1이 유효할 때 발생했고,
    아직 미처리된 결제 이중 청구 사건을 다 보여줘."

---

## 9. 요약

1. **World** 는 FACT / RULE / BOOK 테이블들의 컨테이너다.
2. **FACT 테이블**

   * 세계의 상태(State)를 표현
   * Timeline Keyframe을 중심으로 `valid_from / valid_until`로 시간 표현
3. **RULE 테이블**

   * 법칙/정책/물리 룰을 표현
   * 마찬가지로 Keyframe 기반의 `effective_from / effective_until`을 가짐
4. **BOOK 테이블**

   * 서술 / 로그 / 보고서 원문 저장
   * 자체 타임라인 축은 없고,

     * `RECORDED_AT` (기록 시간)
     * `EVENT_AT` (사건 시간 추론 결과)
       를 **메타 엣지로만 표현**
5. 이 구조를 통해:

   * **인간의 타임라인 기반 인식**을 그대로 반영하면서,
   * 서술(Book)은 **가볍게**,
   * 모델/룰은 **타임라인 중심으로 정교하게** 관리할 수 있다.

```text
BOOK  →  (SCULPT / 파서)  →  FACT / RULE (Timeline 기반)
FACT / RULE  →  (WRENDER / 질의) →  서술/보고/설명 생성
```

이게 현재까지 확정된 **World 테이블 구조의 기본 골격**이다.