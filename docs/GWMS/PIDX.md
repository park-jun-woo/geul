# **PIDX.md — Pattern Index 설계 명세서**

## **1. PIDX란 무엇인가? (정의)**

**PIDX (Pattern Index)**는 다음을 의미한다:

> **“사용자 또는 시스템이 비싼 연산(규칙·수학·신경망·타임라인 분석)을 수행해 얻은 고차원 패턴을,
> SIDX 수준의 성능으로 즉시 조회할 수 있도록 굽는(Grounding) 특수 인덱스 레이어.”**

즉, PIDX는 **일반 의미정렬 인덱스(SIDX)의 상위 레이어**이며,
다음 목표를 갖는다:

* 비싼 패턴 탐지 연산 → **딱 1번만 수행**
* 그 결과를 **인덱스(패턴 노드)**로 저장
* 모든 질의는 이후부터 **저가 심볼릭 탐색(O(1))**으로 대체

---

## **2. SIDX vs PIDX**

| 구분  | SIDX (Standard Semantic-Aligned Index) | PIDX (Pattern Index)                         |
| --- | -------------------------------------- | -------------------------------------------- |
| 목적  | 기본 의미좌표로 후보군을 빠르게 축소                   | 고차원 패턴을 저가로 재사용                              |
| 생성  | GEUL 표준 또는 공식 알고리즘                     | 사용자 정의, 규칙·수학·신경망 기반                         |
| 연산비 | 매우 낮음                                  | 생성은 비싸지만 조회는 매우 빠름                           |
| 예시  | “성별=남성”, “종=개”, “국적=KR”                | “천천히 하락 후 급등한 주식”, “군견 적합 견종”, “장기 우울 패턴 인물” |
| 활용  | 1차 필터                                  | 2차 슈퍼필터 (고급 패턴)                              |
| 범위  | 범용                                     | 월드/도메인 특수                                    |

---

## **3. 왜 PIDX가 필요한가?**

SIDX만으로는 잡히지 않는 패턴들이 현실에 매우 많다:

* **시간 패턴:** "서서히 하락하다가 급등한 주식"
* **연속 감정 패턴:** "3개월간 우울 경향 증가"
* **행동 패턴:** "습관적 거짓말 + 공격성 증가"
* **정치적 패턴:** "정권 위기 국면에 진입하는 지표 조합"
* **서사 패턴:** "사건-결과-복수의 구조가 반복되는 등장인물"

이런 패턴은 대부분:

1. 시계열 분석
2. 파생 변수 계산
3. 문맥 유사도
4. NN classifier
5. 규칙 조합

등 **고비용 연산**을 필요로 한다.

> 따라서 “한 번 비싸게 계산하고, 이후엔 O(1)에 가깝게 조회”하는 구조가 필요하다.
> 그것이 PIDX이다.

---

## **4. PIDX의 구조 (스키마)**

PIDX는 두 개의 테이블/배열로 구성된다.

---

### **4.1 PIDX 메타 테이블 (PIDX Metadata)**

각 PIDX는 하나의 인덱스 정의를 갖는다.

```
PIDX {
  PIDX_id: uint64
  name: string
  description: string

  world_id: uint64
  rule_ref: RIDX_id or ScriptRef or ModelRef

  created_at: timestamp
  updated_at: timestamp

  status: ACTIVE | STALE | ARCHIVED
  cost_tag: LOW | MID | HIGH
}
```

---

### **4.2 PIDX 엔트리 테이블 (PIDX Entries)**

PIDX는 (PIDX → SIDX) 관계들의 묶음이다.

```
PIDX_ENTRY {
  PIDX_id: uint64
  SIDX: uint64
  score: float32        // 0.0 ~ 1.0
  meta: json or small blob (분석 시점, 기간, 특징량 등)
}
```

GWMS 내부에서는 다음과 동등하다:

```
(PIDX) --[HAS_MEMBER, score = x]--> (SIDX)
```

---

## **5. PIDX 생성 시나리오 (라이프 사이클)**

PIDX는 다음 절차로 생성된다.

---

### **5.1 생성 (Build)**

1. **패턴 정의 (Rule/Model Pipeline 정의)**
   예: “SLOW_DROP → SPIKE 패턴”, “군견 적합성”

2. **전수 스캔 또는 제한 스캔**
   특정 타입의 모든 SIDX에 대해 패턴 탐지 수행

3. **PIDX 엔트리 생성**
   패턴을 만족하는 SIDX에 대해 score 포함 등록

4. **PIDX 활성화**
   status = ACTIVE

---

### **5.2 갱신 (Refresh)**

세계가 갱신되면 패턴이 깨질 수 있으므로 PIDX도 갱신이 필요:

* Full rebuild (간단하지만 비용 큼)
* Incremental update (복잡하지만 비용 절감)

또는 PIDX에 **staleness_score**를 부여해
오래된 PIDX를 플래너가 스스로 피하게 할 수 있음.

---

### **5.3 아카이브 (Archive)**

사용 빈도가 낮아지면 다음 절차:

* 파일로 덤프하고 메모리/인덱스에서 제거
* status = ARCHIVED
* 필요 시 로드 또는 재빌드

이때 다음 같은 현상이 발생한다:

> “대부분의 질의는 빠르지만,
> 아카이브 PIDX와 관련된 특수 질의는 5~20분 걸릴 수 있다.”

---

## **6. PIDX 생성 조건 (Trigger Policy)**

PIDX는 무분별하게 찍어내면 인덱스 폭발이 발생하기 때문에
명확한 트리거 조건이 필요.

### **6.1 사용자 요청 기반**

“이 패턴 자주 쓰니까 PIDX로 만들어라.”

### **6.2 반복 질의 기반**

동일 패턴의 질의가 N회 이상 반복되면 플래너가
“PIDX 생성 후보”로 자동 등록.

### **6.3 운영자 정책 기반 (Admin/DBA)**

엔터프라이즈 환경이라면 DBA가 직접 관리.

---

## **7. 쿼리 플래너에 의한 활용**

쿼리 플래너의 질의 처리 흐름:

1. **PIDX 우선 검색**
   질의 패턴이 PIDX에 등록되어 있으면 즉시
   PIDX_ENTRY에서 SIDX 목록을 꺼내 끝낸다.

2. **PIDX 없을 때 (Plan B)**

   * SIDX로 1차 후보군 축소
   * 심볼릭 필터
   * 그래도 부족하면 신경망+수학 파이프라인 발동
   * 결과가 충분히 자주 나온다면 PIDX 후보로 저장

---

## **8. 예시**

### **8.1 “천천히 하락 후 급등한 종목”**

* PIDX 이름: `PIDX_STOCK_SLOW_DROP_THEN_SPIKE`
* Rule: 이동평균·변동성 기반 SLOW_DROP → SPIKE
* 전 세계 종목 가격 분석 → PIDX 생성
* 이후 "급등 패턴 종목 추천" 질의는 즉시 O(1)

---

### **8.2 “군견 적합 종”**

* PIDX 이름: `PIDX_DOG_MILITARY_SUITABILITY`
* Rule: 지능·복종성·체력·공격성·훈련성 등 수학적 가중치
* 생성 후 질의: “군견 추천해줘” → 즉시 응답

---

### **8.3 소설/창작용**

* `PIDX_CHAR_GRUDGE_LONG_TERM`
* `PIDX_EVENT_MAJOR_PLOT_POINT`
* `PIDX_CONTEXT_POLITICAL_CRISIS`

작가가 “오랫동안 원한 품는 캐릭터만 보여줘”
→ PIDX로 즉시 해결.

---

## **9. 설계 철학**

PIDX는 다음 철학 위에서 설계된다.

1. **비싼 연산은 한 번만.**
2. **패턴을 인덱스로 굽는다.**
3. **실전 질의는 심볼릭 레벨에서 즉시 해결한다.**
4. **신경망은 태깅/부트스트랩 역할만 한다.**
5. **실제 월드가 폭증해도 속도는 유지한다.**

가장 중요한 목표는:

> **신경망 의존도를 최소화하면서,
> 고차원 패턴을 즉각적 탐색으로 변환하는 것.**

---

## **10. 요약 (Short Summary)**

* PIDX = 고비용 패턴을 저가 탐색으로 변환하는 고급 인덱스
* SIDX의 상위에 존재하는 “패턴 레이어”
* 생성은 비싸지만 조회는 빠르다
* PIDX는 GWMS의 스케일 문제를 해결하는 필수 요소
* 쿼리 플래너는 PIDX를 최우선 사용
* 아카이브/복원 전략으로 인덱스 폭발 방지
* 신경망 사용을 "최소화하고 재사용"하는 핵심 구조
