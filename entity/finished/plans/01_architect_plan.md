# GEUL Entity SIDX Architect Plan v1.0

작성일: 2026-02-01

---

## 1. 전체 아키텍처 검토

### 1.1 64비트 스키마 구조

```
+--------+------+------------+----------------------------------+
|Prefix  | Mode | EntityType |         Attributes (48비트)       |
| 7비트  | 3비트|   6비트    |  타입별 완전 독립 스키마           |
+--------+------+------------+----------------------------------+
  Word 1 (16비트)              Words 2-4 (48비트)
```

### 1.2 설계 원칙 재확인

| 원칙 | 현재 상태 | 평가 |
|------|----------|------|
| **타입별 완전 독립** | 5개 타입 스키마 정의됨 | 59개 타입 미정의 |
| **계층적 해석** | Era→Polity, Country→Admin 정의됨 | 구현 필요 |
| **우아한 열화** | 상위 비트부터 배치 원칙 확립 | 검증 필요 |
| **SIMD 최적화** | 비트 경계 워드 정렬 고려 | Stage 3에서 검증 |
| **기계적 할당** | 양자화 규칙 정의됨 | LLM 테스트 필요 |
| **UID 없음** | 외부 ID Triple 분리 원칙 확립 | 유지 |

### 1.3 현재 진행 상황

- **Stage 1 완료**: 5개 타입(Human, Star, Settlement, Organization, Film) 속성 추출
- **Stage 2-5 미실행**: 의존성 탐지, 비트 할당, 코드북 생성, 검증 대기 중
- **핵심 파일 정비 완료**: `entity_types_64.json`, `type_schemas.json`, `quantization_rules.json`

---

## 2. Stage별 트레이드오프 분석

### 2.1 Stage 2: 의존성 탐지

#### 현재 설계
```python
# 종속 판별 기준
MI_THRESHOLD = 0.3  # I(A;B) / min(H(A), H(B)) > 0.3 이면 종속
```

#### 트레이드오프

| 임계값 | 종속 간선 수 | 장점 | 단점 |
|--------|-------------|------|------|
| 0.2 | 많음 (~150개) | 미묘한 종속도 포착 | 오탐 증가, DAG 복잡 |
| **0.3** | 중간 (~80개) | 균형 | 일부 약한 종속 누락 |
| 0.4 | 적음 (~40개) | 명확한 종속만 | 계층 구조 단순화 |

#### [DECISION] MI 임계값 선택
- **제안**: 0.3 유지 (파이프라인 문서 기준)
- **대안**: 타입별 차등 적용 (Human은 0.25, 단순 타입은 0.35)
- **근거**: Human의 시대-국가 종속은 약하지만 중요하므로 낮은 임계값 필요

### 2.2 Stage 3: 비트 할당 우선순위

#### 현재 설계
탐욕적 할당: 커버리지 × 엔트로피 높은 속성부터 비트 배정

#### 트레이드오프

| 전략 | 충돌률 | 표현력 | SIMD 효율 |
|------|-------|--------|----------|
| **충돌률 최소화** | 0.5% | 낮음 | 높음 |
| **표현력 최대화** | 2-3% | 높음 | 중간 |
| **균형** | 1% | 중간 | 중간 |

#### [DECISION] 비트 할당 전략
- **제안**: 타입별 차등 적용
  - 10M+ 개체 타입(Human, Star): 충돌률 최소화 우선
  - 100K 미만 타입: 표현력 최대화 가능
- **근거**: 대규모 타입의 충돌 1%는 절대 수로 10만 개 이상, 소규모는 충돌 영향 적음

### 2.3 Stage 4: 코드북 생성 전략

#### 트레이드오프

| 전략 | 장점 | 단점 |
|------|------|------|
| **빈도 기반** | 데이터 기반, 자동화 용이 | 희귀 값 불리, 의미 무시 |
| **의미 기반** | 논리적 그룹핑 | 수동 작업, 주관성 |
| **하이브리드** | 둘 다 반영 | 구현 복잡 |

#### [DECISION] 코드북 생성 방식
- **제안**: 하이브리드 (빈도 70% + 의미 그룹 30%)
  1. 상위 70% 코드: 빈도 내림차순 할당
  2. 하위 20% 코드: 의미적으로 관련된 값 그룹핑
  3. 마지막 10%: Reserved (파이프라인 원칙)
- **근거**: 빈도만으로는 "Korea"와 "South Korea" 같은 의미적 관계 무시됨

---

## 3. 위험 요소 및 대응책

### 3.1 스키마 미정의 타입 (59개)

#### 현황
```
정의됨 (5개):  Human, Star, Settlement, Organization, Film
미정의 (59개): Taxon, Gene, Protein, Galaxy, ... 등
```

#### 위험 분석

| 위험 | 심각도 | 발생 가능성 |
|------|--------|------------|
| 59개 타입 수동 설계 불가 | 높음 | 확실 |
| default_schema 충돌률 높음 | 중간 | 높음 |
| 타입간 스키마 불일치 | 중간 | 중간 |

#### [DECISION] 미정의 타입 처리 전략
- **옵션 A**: 자동 생성 (권장)
  - Stage 1~3을 64개 타입 전체에 실행
  - 데이터 기반 최적 스키마 자동 생성
  - 사람은 결과 검토만 수행

- **옵션 B**: 카테고리별 템플릿
  - 9개 카테고리별 공통 스키마 정의
  - 동일 카테고리 타입은 같은 템플릿 사용
  - 예: "천체" 카테고리 → Star 스키마 변형 적용

- **제안**: 옵션 A + B 병행
  1. 주요 10개 타입: 자동 생성 후 수동 검토
  2. 나머지 54개 타입: 카테고리 템플릿 적용
  3. 예약 타입(0x3F): 미처리

### 3.2 높은 카디널리티 속성 처리

#### 문제 속성 목록

| 타입 | 속성 | 카디널리티 | 문제 |
|------|------|-----------|------|
| Human | P735 (이름) | 9,903 | 48비트 불가 |
| Human | P734 (성) | 26,858 | 48비트 불가 |
| Human | P569 (생년월일) | 34,960 | 일 단위 인코딩 불가 |
| Star | P528 (카탈로그) | 259,096 | 외부 ID |
| Settlement | P131 (행정구역) | 16,310 | 국가별 종속 |

#### [DECISION] 고카디널리티 속성 처리
- **전략 1: 양자화** (시간, 좌표, 인구)
  - 이미 `quantization_rules.json`에 정의됨
  - Era (4비트) + Decade (4비트) = 8비트로 연도 표현

- **전략 2: 외부 분리** (이름, 카탈로그 코드)
  - 48비트에 포함하지 않음
  - Triple Edge로 별도 저장: `[Entity] --hasName--> [Name Entity]`

- **전략 3: 계층적 코드북** (행정구역)
  - Country (8비트) × AdminCode (8비트) = 국가당 256개 행정구역
  - 부모 값(Country)에 따라 자식 코드북 결정

### 3.3 충돌 처리 전략

#### 충돌 유형
1. **완전 충돌**: 두 개체가 동일한 48비트 (구분 불가)
2. **부분 충돌**: 상위 비트만 동일 (열화 시 구분 불가)

#### [DECISION] 충돌 허용 정책
- **목표 충돌률**: 타입별 규모에 따라 차등
  ```
  10M+:   < 1%  (Human 12.5M → 최대 125K 충돌)
  1M-10M: < 3%  (Star 3.6M → 최대 108K 충돌)
  100K-1M:< 1%
  <100K:  < 0.5%
  ```

- **충돌 발생 시 처리**:
  - SIDX만으로 구분 불가 → Context Edge 또는 Triple Edge로 추가 특정
  - "1900년대 미국 남성 배우 중 더 유명한 쪽"처럼 notability로 disambiguation

---

## 4. 의사결정 포인트 (사용자 승인 필요)

### [DECISION-1] 파이프라인 범위
- **질문**: Stage 1을 64개 전체 타입에 실행할 것인가?
- **옵션**:
  - A) 주요 10개 타입만 (Human, Star, Galaxy, Taxon, Settlement, Organization, Film, Painting, Gene, Chemical)
  - B) 64개 전체 타입
- **권장**: A (10개 타입으로 파이프라인 검증 후 확장)
- **소요 시간**: A는 약 2시간, B는 약 8시간

### [DECISION-2] 스키마 자동화 수준
- **질문**: 자동 생성된 스키마를 얼마나 신뢰할 것인가?
- **옵션**:
  - A) 완전 자동: 데이터 기반 결과 그대로 사용
  - B) 반자동: 주요 10개 타입은 수동 검토, 나머지 자동
  - C) 완전 수동: 모든 타입 수동 설계
- **권장**: B

### [DECISION-3] 코드북 언어
- **질문**: 코드북의 라벨을 어떤 언어로 작성할 것인가?
- **옵션**:
  - A) 영어만
  - B) 영어 + 한국어 병기
  - C) 다국어 (영/한/중/일)
- **권장**: B (GEUL 프로젝트의 한국어 지향성 반영)

### [DECISION-4] Reserved 비트 정책
- **질문**: 각 타입의 48비트 중 Reserved 영역을 얼마나 확보할 것인가?
- **옵션**:
  - A) 고정 16비트 (type_schemas.json 현재 기준)
  - B) 타입별 가변 (8~16비트)
  - C) Reserved 없음 (모든 비트 활용)
- **권장**: B (대규모 타입은 적게, 소규모 타입은 많이)

### [DECISION-5] 열화 단위
- **질문**: 우아한 열화의 단위를 어떻게 정할 것인가?
- **옵션**:
  - A) 4비트 단위 (12단계 열화)
  - B) 8비트 단위 (6단계 열화)
  - C) 필드 단위 (가변)
- **권장**: C (필드 경계에서 열화가 의미적으로 자연스러움)

---

## 5. 최종 산출물 정의

### Stage 1 Output (완료)
| 파일 | 위치 | 내용 |
|------|------|------|
| stage1_report.md | output/ | 속성 통계 요약 |
| entity_type_map | geulwork DB | EntityType 매핑 테이블 |
| property_stats | geulwork DB | 타입별 속성 통계 |

### Stage 2 Output
| 파일 | 위치 | 내용 |
|------|------|------|
| stage2_report.md | output/ | DAG 시각화 (mermaid), 종속 관계 목록 |
| dependency_dag | geulwork DB | 속성 간 종속 관계 |
| [REVIEW] 태그 | 보고서 내 | MI 경계값 근처 관계 검토 요청 |

### Stage 3 Output
| 파일 | 위치 | 내용 |
|------|------|------|
| stage3_report.md | output/ | 비트 할당 결과, 충돌률 통계 |
| bit_allocation | geulwork DB | 타입별 필드-비트 매핑 |
| collision_stats | geulwork DB | 충돌 통계 |
| type_schemas_v2.json | references/ | 업데이트된 스키마 파일 |

### Stage 4 Output
| 파일 | 위치 | 내용 |
|------|------|------|
| stage4_report.md | output/ | 코드북 생성 요약 |
| codebooks/*.md | output/codebooks/ | 타입별 코드북 마크다운 |
| codebook | geulwork DB | 전체 코드 테이블 |
| [REVIEW] 태그 | 보고서 내 | LLM 검증 실패 항목 |

### Stage 5 Output
| 파일 | 위치 | 내용 |
|------|------|------|
| stage5_report.md | output/ | 전체 검증 결과 |
| 검증 항목 | - | 5-A: 충돌률, 5-B: 추상 쿼리, 5-C: 일관성, 5-D: 열화 |
| [REVIEW] 태그 | 보고서 내 | 목표 미달 항목 |

### 최종 산출물
| 파일 | 위치 | 내용 |
|------|------|------|
| entity_sidx_schema_final.json | output/ | 64개 타입 전체 스키마 |
| entity_sidx_codebook_final.json | output/ | 전체 코드북 통합 |
| SIDX_SPEC.md | output/ | 최종 스펙 문서 |

---

## 6. 다음 단계 권장 실행 순서

```bash
# 1. Stage 2 실행 (5개 타입)
python scripts/stage2_dependency.py 0x00 0x0C 0x1C 0x2C 0x33

# 2. Stage 2 결과 검토 후 Stage 3
python scripts/stage3_allocate.py 0x00 0x0C 0x1C 0x2C 0x33

# 3. Stage 4 코드북 생성
python scripts/stage4_codebook.py 0x00 0x0C 0x1C 0x2C 0x33

# 4. Stage 5 검증
python scripts/stage5_validate.py 0x00 0x0C 0x1C 0x2C 0x33

# 5. 결과 검토 후 나머지 타입 확장 결정
```

---

## 7. 승인 요청 체크리스트

아래 항목에 대한 결정이 필요합니다:

- [ ] **[DECISION-1]** 파이프라인 범위: 10개 타입 vs 64개 타입
- [ ] **[DECISION-2]** 스키마 자동화 수준: 완전 자동 vs 반자동 vs 완전 수동
- [ ] **[DECISION-3]** 코드북 언어: 영어만 vs 영한 병기 vs 다국어
- [ ] **[DECISION-4]** Reserved 비트: 고정 16비트 vs 타입별 가변 vs 없음
- [ ] **[DECISION-5]** 열화 단위: 4비트 vs 8비트 vs 필드 단위

---

*End of Architect Plan*
